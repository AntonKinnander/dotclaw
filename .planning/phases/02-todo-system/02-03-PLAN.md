# PLAN 02-03: Poll-Based Checklists

## Objective

Implement Discord polls as task checklists. Each subtask becomes a poll option, multi-select allows tracking progress, and poll state is synchronized with task completion.

## Context

@file:src/providers/discord/discord-provider.ts - Existing `sendPoll` method
@file:src/types.ts - DailyTask with poll_data field

## Tasks

### Task 1: Create poll manager module

**Type:** `task` | **Files:** `src/poll-manager.ts` (new)

**Action:**
Create module for managing Discord polls as checklists:

```typescript
export interface PollChecklist {
  question: string;  // Main task title
  answers: Array<{
    id: number;
    text: string;    // Subtask with emoji: "ðŸ”§ Fix authentication"
    emoji: string;
    checked: boolean;
  }>;
}

export class PollManager {
  // Create a poll for task subtasks
  async createTaskPoll(
    taskId: string,
    mainTask: string,
    subtasks: string[],
    channelId: string
  ): Promise<string>;  // Returns poll ID

  // Update poll based on answers
  async updatePollFromAnswers(
    pollId: string,
    channelId: string,
    messageId: string,
    answers: PollChecklist['answers']
  ): Promise<void>;

  // Check if poll is complete (all items checked)
  async isPollComplete(
    pollId: string,
    channelId: string,
    threadId: string
  ): Promise<boolean>;

  // Handle reaction override (âœ… on thread = complete)
  async handleThreadReaction(
    threadId: string,
    emoji: string
  ): Promise<boolean>;  // Returns true if task should be marked complete

  // Sync poll state from Discord API
  async syncPollState(
    pollId: string,
    channelId: string,
    messageId: string
  ): Promise<PollChecklist>;
}
```

**Key Implementation Details:**
- Use Discord's native poll API (discord.js v14.15+)
- Poll answers represent subtasks (max 10)
- Track checked state via answer votes
- âœ… reaction on thread marks entire task complete

**Verify:**
- Can create poll with subtasks as answers
- Poll is multi-select
- Can update poll state
- Can detect completion

**Done when:** Poll manager creates and tracks polls

---

### Task 2: Add poll state synchronization

**Type:** `task` | **Files:** `src/poll-manager.ts`

**Action:**
Implement poll state sync with database:

```typescript
// Update task's poll_data in database when poll changes
export async function syncPollToTask(
  taskId: string,
  pollData: PollChecklist
): Promise<void>;

// Periodic sync for all active polls
export async function syncAllActivePolls(): Promise<{
  synced: number;
  completed: number;  // Tasks marked complete from poll
}>;

// Check for poll completion via reaction
export async function checkReactionCompletion(
  threadId: string,
  reactions: Array<{emoji: string; count: number}>
): Promise<boolean>;
```

**Sync Logic:**
1. Query Discord API for current poll state
2. Compare with stored poll_data
3. Update if changed
4. If all answers have votes, mark task complete
5. If âœ… reaction on thread, mark complete immediately

**Verify:**
- Poll changes sync to database
- All-checked detection works
- Reaction override works
- Multiple active polls sync correctly

**Done when:** Poll state stays synchronized

---

### Task 3: Create poll event handlers

**Type:** `task` | **Files:** `src/providers/discord/discord-provider.ts`

**Action:**
Add Discord event handlers for poll changes:

```typescript
// Handle poll vote changes
this.client.on('pollVoteAdd', (vote: DiscordPollVote) => {
  const taskId = this.getTaskIdFromPoll(vote.poll);
  if (taskId) {
    void this.handlePollVoteChange(taskId, vote);
  }
});

// Handle thread reactions (for completion override)
this.client.on('messageReactionAdd', (reaction: DiscordMessage, user: DiscordMessage) => {
  if (reaction.emoji?.name === 'âœ…' && reaction.message?.isThread?.()) {
    const threadId = String(reaction.message.id);
    void this.handleThreadCompletion(threadId);
  }
});
```

**Verify:**
- Poll votes trigger state sync
- Reaction on thread marks task complete
- Handlers don't crash on edge cases

**Done when:** Poll events are handled correctly

---

## Verification (Overall)

1. **Poll Creation:**
   - Create task with subtasks
   - Poll is created in thread
   - All subtasks appear as poll options

2. **Poll Tracking:**
   - Vote on poll option
   - Database updates poll_data
   - Task status changes when all voted

3. **Reaction Override:**
   - Add âœ… reaction to thread
   - Task marked complete immediately
   - Poll still shows individual progress

## Success Criteria

- [ ] PollManager module exists and works
- [ ] Polls created with subtasks as options
- [ ] Poll state syncs to database
- [ ] All-checked detection works
- [ ] âœ… reaction marks task complete
- [ ] Event handlers process poll changes

## Output

SUMMARY.md should contain:
- PollManager created at `src/poll-manager.ts`
- Poll creation and sync implementation
- Event handlers for poll changes
- Example poll as checklist
- Reaction override behavior
