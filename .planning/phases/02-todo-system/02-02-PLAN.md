# PLAN 02-02: Forum Thread Manager

## Objective

Create a module for managing Discord forum threads for tasks. Each main task gets its own thread, threads are archived after 24 hours, and thread state is tracked.

## Context

@file:src/providers/discord/discord-provider.ts - Discord API access
@file:src/db.ts - Task storage with Discord refs
@file:src/types.ts - DailyTask type

## Tasks

### Task 1: Create forum thread manager module

**Type:** `task` | **Files:** `src/forum-thread-manager.ts` (new)

**Action:**
Create module for forum thread lifecycle:

```typescript
export interface ForumThreadConfig {
  group_folder: string;
  forum_channel_id: string;  // The TO-DO forum channel
}

export interface TaskThread {
  task_id: string;
  channel_id: string;
  thread_id: string;
  title: string;
  created_at: string;
  archived_at: string | null;
}

export class ForumThreadManager {
  // Create a new thread for a task
  async createTaskThread(task: DailyTask, forumChannelId: string): Promise<TaskThread>;

  // Archive a task thread
  async archiveTaskThread(threadId: string): Promise<void>;

  // Archive threads older than 24 hours
  async archiveOldThreads(forumChannelId: string): Promise<number>;

  // Get thread for a task
  getTaskThread(taskId: string): TaskThread | null;

  // Update thread status
  updateThreadStatus(taskId: string, status: 'locked' | 'archived'): Promise<void>;
}
```

**Key Implementation Details:**
- Use discord.js forum thread creation
- Store thread mappings in memory (with file persistence)
- Auto-archive based on created_at timestamp
- Handle thread metadata tags for status

**Verify:**
- Can create thread for task
- Thread appears in Discord forum
- Can archive thread
- Old threads are auto-archived

**Done when:** Module can create and manage forum threads

---

### Task 2: Add Discord methods for thread operations

**Type:** `task` | **Files:** `src/providers/discord/discord-provider.ts`

**Action:**
Add forum thread methods to DiscordProvider:

```typescript
// Create a forum thread
async createForumThread(
  chatId: string,
  title: string,
  content: string,
  options?: {
    tags?: string[];
    autoArchiveDuration?: number;  // Discord minutes
  }
): Promise<SendResult>;

// Archive a thread
async archiveThread(chatId: string, threadId: string): Promise<void>;

// Lock a thread (prevent new replies)
async lockThread(chatId: string, threadId: string): Promise<void>;

// Get thread info
async getThread(chatId: string, threadId: string): Promise<{
  id: string;
  title: string;
  isArchived: boolean;
  isLocked: boolean;
  messageCount: number;
} | null>;
```

**Verify:**
- Methods compile and are callable
- Discord API calls succeed
- Thread is created with correct settings
- Archive and lock work

**Done when:** All thread operations work via provider

---

### Task 3: Create thread state persistence

**Type:** `task` | **Files:** `src/forum-thread-manager.ts`

**Action:**
Add file-based persistence for thread mappings:

```typescript
interface ThreadState {
  threads: Record<string, TaskThread>;  // task_id -> TaskThread
  last_archived_check: string;
}

const STATE_FILE = path.join(DATA_DIR, 'task-threads.json');

export function loadThreadState(): ThreadState;
export function saveThreadState(state: ThreadState): void;
export function updateThreadState(taskId: string, thread: TaskThread): void;
```

**Verify:**
- State persists across bot restarts
- Load returns valid state
- Save updates file correctly
- Missing state file doesn't crash

**Done when:** Thread state persists correctly

---

## Verification (Overall)

1. **Manager Check:**
   ```typescript
   const manager = new ForumThreadManager({ group_folder: 'main', forum_channel_id: '123' });
   await manager.createTaskThread(task, '123');
   // Verify thread exists in Discord
   ```

2. **Persistence Check:**
   - Create thread
   - Restart bot
   - Thread mapping still exists

3. **Archive Check:**
   - Create thread
   - Wait or mock time passage
   - Run archiveOldThreads
   - Thread is archived in Discord

## Success Criteria

- [ ] ForumThreadManager module exists
- [ ] Discord provider has thread operations
- [ ] Thread state persists across restarts
- [ ] Auto-archive works for threads >24 hours

## Output

SUMMARY.md should contain:
- ForumThreadManager created at `src/forum-thread-manager.ts`
- Discord provider thread methods added
- Thread persistence implementation
- Example thread creation and archival
