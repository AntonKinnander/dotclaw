# PLAN 02-04: Daily Planning Flow

## Objective

Create the collaborative daily planning flow where the user and bot agree on the day's major tasks, which are then broken down and posted as forum threads with polls.

## Context

@file:src/task-breakdown.ts - Task breakdown from 02-01
@file:src/forum-thread-manager.ts - Thread management from 02-02
@file:src/poll-manager.ts - Poll checklists from 02-03

## Tasks

### Task 1: Create daily planning skill

**Type:** `task` | **Files:** `global/skills/daily-planning/SKILL.md` (new skill)

**Action:**
Create a skill for collaborative daily planning:

```markdown
---
name: daily-planning
description: Collaboratively plan daily tasks with the user, breaking them into actionable subtasks
license: MIT
---

# Daily Planning

You are the daily planning assistant. Work with the user to plan their day productively.

## Your Role

You are a **thoughtful accountability partner**, not a yes-man. Your job is to:
- Keep the user focused on their goals
- Challenge unrealistic plans gently
- Suggest prioritization when overloaded
- Hold the user accountable to previous commitments

## Planning Process

1. **Start with context:**
   - What's already in progress?
   - What was planned but not done yesterday?
   - What are the current goals/priorities?

2. **Collaborate on tasks:**
   - Ask what they want to accomplish today
   - Offer suggestions based on context
   - Push back if the plan is overloaded
   - Help prioritize when there's too much

3. **Confirm the plan:**
   - Summarize agreed-upon tasks
   - Get explicit confirmation
   - Only then proceed to breakdown

4. **Break down and post:**
   - Use task-breakdown subagent for each major task
   - Create forum thread with poll checklist
   - Confirm each task is posted

## Conversation Style

- **Collaborative:** "What do you think about tackling X first?"
- **Accountable:** "That's quite a lot - are you sure you can finish Y and Z today?"
- **Flexible:** "If X doesn't work out, we can always adjust"
- **Supportive:** "Great focus area for today!"

## Tools Available

- `get_tasks_for_date` - What's pending/in-progress
- `memory_search` - Current goals and priorities
- `breakdown_task` - Create subtasks for major tasks
- `create_task_thread` - Create forum thread with poll
- `get_journal_context` - Yesterday's outcomes

## Example Flow

You: "Morning! Based on yesterday's journal, you were working on the auth bug and had the API redesign queued up. What's the plan for today?"

User: "I want to finish the auth bug, start the API redesign, and also look at that new feature request."

You: "The auth bug makes sense to finish. For the API redesign - that's usually a 2-3 day project. What part were you thinking of tackling?"

User: "Just the endpoint restructuring."

You: "Okay, that's reasonable. The new feature request though - I see you have 3 other tasks already in progress. Should we defer that to keep focus?"

...and so on until agreement, then breakdown and post.

## Guidelines

- **Max 3-5 major tasks per day** - Quality over quantity
- **Each task should be 2-8 hours** - Break down larger tasks
- **Respect user agency** - They can override your suggestions
- **Learn patterns** - Note what the user typically accomplishes
```

**Verify:**
- Skill exists and is discoverable
- Guidelines emphasize accountability
- Tools are referenced correctly

**Done when:** Planning skill guides conversation well

---

### Task 2: Create planning orchestrator module

**Type:** `task` | **Files:** `src/daily-planning.ts` (new)

**Action:**
Create module that orchestrates the planning workflow:

```typescript
export interface PlanningSession {
  group_folder: string;
  date: string;
  forum_channel_id: string;
  agreed_tasks: Array<{
    title: string;
    description?: string;
    context?: Record<string, unknown>;
  }>;
}

export class DailyPlanningOrchestrator {
  // Start a new planning session
  async startSession(groupFolder: string): Promise<PlanningSession>;

  // Add agreed task to session
  addTask(session: PlanningSession, task: {
    title: string;
    description?: string;
    context?: Record<string, unknown>;
  }): void;

  // Break down all agreed tasks and post threads
  async finalizeAndPost(session: PlanningSession): Promise<{
    posted: number;
    threads: Array<{task_id: string; thread_id: string; poll_id: string}>;
  }>;

  // Get planning context for starting conversation
  async getContext(groupFolder: string): Promise<{
    inProgress: DailyTask[];
    yesterdayOutcomes: DailyJournal | null;
    currentGoals: string[];
  }>;
}
```

**Verify:**
- Can start session and get context
- Can add tasks to session
- Finalize breaks down and posts all tasks
- Returns thread/poll IDs for tracking

**Done when:** Orchestrator manages full planning flow

---

### Task 3: Add planning trigger and state management

**Type:** `task` | **Files:** `src/daily-planning.ts`

**Action:**
Add scheduling and state for planning sessions:

```typescript
// Get or create today's planning session
export function getTodaysPlanningSession(groupFolder: string): PlanningSession | null;

// Check if planning is complete for today
export function isPlanningComplete(groupFolder: string, date: string): boolean;

// Mark planning as complete
export function markPlanningComplete(groupFolder: string, date: string): void;

// Reset planning state (for testing or manual override)
export function resetPlanningState(groupFolder: string, date?: string): void;

// Planning state persistence
interface PlanningState {
  sessions: Record<string, {  // "group_folder:YYYY-MM-DD"
    agreed_tasks: PlanningSession['agreed_tasks'];
    posted_at: string | null;
    complete: boolean;
  }>;
}
```

**State File:** `~/.dotclaw/planning-state.json`

**Verify:**
- State persists across restarts
- Can check if planning is done
- Can reset for testing
- Multiple groups don't interfere

**Done when:** Planning state management works

---

## Verification (Overall)

1. **Planning Flow:**
   - Start planning conversation
   - Agree on 2-3 tasks
   - Tasks are broken down
   - Forum threads created with polls

2. **Accountability Check:**
   - Try to overcommit
   - Bot should push back
   - Suggest prioritization

3. **State Check:**
   - Complete planning
   - Check state = complete
   - Reset and plan again

## Success Criteria

- [ ] Daily planning skill exists with accountability focus
- [ ] Orchestrator manages planning workflow
- [ ] Tasks break down and post correctly
- [ ] State tracks planning completion
- [ ] Bot pushes back on overcommitment

## Output

SUMMARY.md should contain:
- Planning skill at `global/skills/daily-planning/SKILL.md`
- Orchestrator module at `src/daily-planning.ts`
- Planning state implementation
- Example planning conversation
- Sample posted task threads with polls
