# PLAN 01-01: Database Schema & Core Types

## Objective

Create the database schema and TypeScript types for the journal, task, and daily briefing systems. This is the foundation for all subsequent phases.

## Context

@file:src/db.ts - Reference for existing DB patterns, migrations, table creation

@file:src/types.ts - Reference for existing TypeScript type definitions

## Tasks

### Task 1: Add database schema for journals, daily tasks, and briefings

**Type:** `task` | **Files:** `src/db.ts`

**Action:**
1. Add new tables to `initDatabase()`:
   - `daily_journals` - journal entries per date
   - `daily_tasks` - atomic tasks linked to journal dates
   - `daily_briefings` - generated briefings
2. Create migration function following existing pattern (`migrateChannelContext`)
3. Add indexes for common queries (date lookups, status filtering)

**New Tables:**

```sql
-- Daily journal entries
CREATE TABLE IF NOT EXISTS daily_journals (
  id TEXT PRIMARY KEY,
  group_folder TEXT NOT NULL,
  date TEXT NOT NULL,  -- ISO date string (YYYY-MM-DD)
  tasks_completed TEXT,      -- JSON array of completed tasks
  tasks_in_progress TEXT,    -- JSON array of in-progress tasks
  sentiment TEXT,            -- positive/neutral/negative
  biggest_success TEXT,
  biggest_error TEXT,
  highlights TEXT,           -- JSON: {good: [], bad: []}
  focus_tomorrow TEXT,
  diary_entry TEXT,          -- Freeform diary (first person)
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  UNIQUE(group_folder, date)
);
CREATE INDEX IF NOT EXISTS idx_journals_date ON daily_journals(date DESC);

-- Atomic daily tasks
CREATE TABLE IF NOT EXISTS daily_tasks (
  id TEXT PRIMARY KEY,
  group_folder TEXT NOT NULL,
  journal_id TEXT,  -- FK to daily_journals (nullable for planned tasks)
  parent_task TEXT, -- For subtasks: parent task ID
  title TEXT NOT NULL,
  description TEXT,
  status TEXT NOT NULL DEFAULT 'pending', -- pending/in_progress/completed/archived
  priority INTEGER DEFAULT 0,
  tags TEXT,           -- JSON array
  metadata TEXT,       -- JSON: {repo, url, calendar_link, etc.}
  discord_channel_id TEXT,
  discord_thread_id TEXT,
  discord_poll_id TEXT,
  poll_data TEXT,      -- JSON: poll options, answers count
  completed_at TEXT,
  created_at TEXT NOT NULL,
  due_date TEXT,
  archived_at TEXT,
  FOREIGN KEY (journal_id) REFERENCES daily_journals(id) ON DELETE SET NULL
);
CREATE INDEX IF NOT EXISTS idx_tasks_status ON daily_tasks(status);
CREATE INDEX IF NOT EXISTS idx_tasks_date ON daily_tasks(created_at DESC);

-- Generated daily briefings
CREATE TABLE IF NOT EXISTS daily_briefings (
  id TEXT PRIMARY KEY,
  group_folder TEXT NOT NULL,
  date TEXT NOT NULL,
  briefing_text TEXT NOT NULL,
  sources TEXT,        -- JSON: {journal_id, tasks, events, etc.}
  delivered_at TEXT,
  created_at TEXT NOT NULL,
  UNIQUE(group_folder, date)
);
CREATE INDEX IF NOT EXISTS idx_briefings_date ON daily_briefings(date DESC);
```

**Verify:**
- Run `npm run build` - should compile
- Start bot - tables should be created automatically
- Check `~/.dotclaw/messages.db` - new tables should exist

**Done when:** Tables exist in DB, migration tracking is in place

---

### Task 2: Add TypeScript types for new entities

**Type:** `task` | **Files:** `src/types.ts`

**Action:**
Add new type definitions matching the database schema:

```typescript
// Journal entry types
export interface DailyJournal {
  id: string;
  group_folder: string;
  date: string;  // YYYY-MM-DD
  tasks_completed: string[];
  tasks_in_progress: string[];
  sentiment: 'positive' | 'neutral' | 'negative';
  biggest_success: string | null;
  biggest_error: string | null;
  highlights: {
    good: string[];
    bad: string[];
  } | null;
  focus_tomorrow: string | null;
  diary_entry: string | null;
  created_at: string;
  updated_at: string;
}

export interface JournalInput {
  group_folder: string;
  date?: string;  // defaults to today
  tasks_completed?: string[];
  tasks_in_progress?: string[];
  sentiment?: DailyJournal['sentiment'];
  biggest_success?: string;
  biggest_error?: string;
  highlights?: DailyJournal['highlights'];
  focus_tomorrow?: string;
  diary_entry?: string;
}

// Daily task types
export interface DailyTask {
  id: string;
  group_folder: string;
  journal_id: string | null;
  parent_task: string | null;
  title: string;
  description: string | null;
  status: 'pending' | 'in_progress' | 'completed' | 'archived';
  priority: number;
  tags: string[] | null;
  metadata: {
    repo?: string;
    url?: string;
    calendar_link?: string;
    [key: string]: unknown;
  } | null;
  discord_channel_id: string | null;
  discord_thread_id: string | null;
  discord_poll_id: string | null;
  poll_data: {
    question: string;
    answers: Array<{
      id: number;
      text: string;
      emoji?: string;
      checked: boolean;
    }>;
  } | null;
  completed_at: string | null;
  created_at: string;
  due_date: string | null;  // YYYY-MM-DD
  archived_at: string | null;
}

export interface TaskInput {
  group_folder: string;
  journal_id?: string;
  parent_task?: string;
  title: string;
  description?: string;
  priority?: number;
  tags?: string[];
  metadata?: DailyTask['metadata'];
  due_date?: string;
}

// Briefing types
export interface DailyBriefing {
  id: string;
  group_folder: string;
  date: string;
  briefing_text: string;
  sources: {
    journal_id?: string;
    tasks?: string[];
    events?: Array<{title: string; time: string}>;
  } | null;
  delivered_at: string | null;
  created_at: string;
}
```

**Verify:**
- Run `npm run typecheck` - should pass
- Import types in test file - should resolve correctly

**Done when:** All types compile and match DB schema

---

### Task 3: Add CRUD functions for journals and tasks

**Type:** `task` | **Files:** `src/db.ts`

**Action:**
Add database accessor functions following existing patterns:

```typescript
// Journal functions
export function createJournal(input: JournalInput): DailyJournal;
export function getJournalByDate(groupFolder: string, date: string): DailyJournal | undefined;
export function getLatestJournal(groupFolder: string): DailyJournal | undefined;
export function updateJournal(id: string, updates: Partial<JournalInput>): void;
export function listJournals(groupFolder: string, limit?: number): DailyJournal[];

// Task functions
export function createTask(input: TaskInput): DailyTask;
export function getTaskById(id: string): DailyTask | undefined;
export function getTasksByJournal(journalId: string): DailyTask[];
export function getTasksForDate(groupFolder: string, date: string): DailyTask[];
export function updateTask(id: string, updates: Partial<TaskInput & {status: DailyTask['status']}): void;
export function setTaskDiscordRefs(id: string, channelId: string, threadId: string, pollId: string): void;
export function updatePollData(id: string, pollData: DailyTask['poll_data']): void;
export function archiveOldTasks(groupFolder: string, olderThanDays?: number): number;

// Briefing functions
export function createBriefing(input: {group_folder: string; date: string; briefing_text: string; sources?: DailyBriefing['sources']}): DailyBriefing;
export function getBriefingByDate(groupFolder: string, date: string): DailyBriefing | undefined;
export function getLatestBriefing(groupFolder: string): DailyBriefing | undefined;
```

**Verify:**
- Create a journal entry via function
- Retrieve it back
- Update it
- Delete it
- Same for tasks

**Done when:** All CRUD operations work, can be imported and used

---

## Verification (Overall)

1. **Schema Check:**
   ```bash
   sqlite3 ~/.dotclaw/messages.db ".tables" | grep -E "daily_|journal|briefing"
   ```
   Should show: `daily_journals`, `daily_tasks`, `daily_briefings`

2. **Type Check:**
   ```bash
   npm run typecheck
   ```
   Should pass with no errors

3. **Build Check:**
   ```bash
   npm run build
   ```
   Should compile successfully

4. **Runtime Check:**
   Start the bot - should initialize without errors, migrations should run

## Success Criteria

- [ ] New database tables exist and are properly indexed
- [ ] TypeScript types match database schema exactly
- [ ] CRUD functions can create, read, update, and delete all entities
- [ ] Migration system tracks schema changes
- [ ] Code compiles and bot starts successfully

## Output

SUMMARY.md should contain:
- Tables created with column definitions
- Types exported from `src/types.ts`
- CRUD functions added to `src/db.ts`
- Any deviations encountered during implementation
