# PLAN 01-04: Nightly Recap Flow

## Objective

Create a conversational nightly recap flow that gathers information the bot doesn't know (sentiment, highs/lows, tomorrow's focus) and generates a structured journal entry. The conversation should feel natural, not like an interview.

## Context

@file:src/journal-manager.ts - Journal creation
@file:container/agent-runner/src/tools.ts - Tool definitions

## Tasks

### Task 1: Create nightly recap skill

**Type:** `task` | **Files:** `global/skills/nightly-recap/SKILL.md` (new skill)

**Action:**
Create a skill that guides the nightly recap conversation:

```markdown
---
name: nightly-recap
description: Conduct reflective end-of-day recap and create journal entry
license: MIT
---

# Nightly Recap

You are the nightly recap assistant. Help the user reflect on their day and create a journal entry.

## What You Already Know

Before starting, check:
- How many tasks were completed today (from task system)
- What tasks are still in progress
- Any previous journal entries for context

## What You Need to Learn

Through natural conversation, gather:
1. **Sentiment** - How did the user feel about today? (positive/neutral/negative)
2. **Highlights** - At least one good thing, one challenging thing
3. **Proudest Moment** - What was the user most happy with?
4. **Biggest Challenge** - What didn't go well? Any mistakes?
5. **Tomorrow's Focus** - What should be prioritized tomorrow?

## Conversation Guidelines

- **Be conversational, not interrogative** - Flow naturally between topics
- **Read the room** - If the user had a hard day, be gentle. If energized, match that energy.
- **Fill gaps intelligently** - You know task completion counts; don't ask for that
- **Offer insights** - Based on what you know, offer observations about patterns
- **Flexible depth** - Some users want quick recaps, others want deep reflection

## Journal Entry Structure

When complete, create a journal entry with:
- `tasks_completed`: Array of completed task titles
- `tasks_in_progress`: Array of ongoing task titles
- `sentiment`: positive/neutral/negative
- `highlights`: { good: [], bad: [] }
- `biggest_success`: User's proudest moment
- `biggest_error`: Main challenge or mistake
- `focus_tomorrow`: What to prioritize
- `diary_entry`: First-person narrative summary (2-3 sentences)

## Example Flow

You: "Hey! How did your day go overall?"
User: "Pretty good, got a lot done."
You: "Nice! I see you knocked out 5 tasks including the authentication fix. What are you feeling best about from today?"
User: "Probably getting that bug fix deployed."
You: "That's a solid win. Anything that didn't go as planned?"
...and so on, naturally flowing through topics.

## Tools Available

- `get_tasks_for_date` - Get task completion status
- `create_journal` - Create the final journal entry
- `memory_search` - Reference previous conversations for context
```

**Verify:**
- Skill is discoverable by agent
- Skill content matches guidelines
- Agent follows conversational approach

**Done when:** Skill file exists with complete guidelines

---

### Task 2: Add task completion query tools

**Type:** `task` | **Files:** `container/agent-runner/src/tools.ts`

**Action:**
Add tools for querying task status:

```typescript
{
  name: 'get_task_summary_for_date',
  description: 'Get summary of tasks completed and in-progress for a date',
  inputSchema: {
    type: 'object',
    properties: {
      date: { type: 'string', description: 'YYYY-MM-DD, defaults to today' }
    }
  },
  // Returns: { completed: Task[], in_progress: Task[], pending: Task[] }
},
{
  name: 'get_task_completion_count',
  description: 'Get count of completed vs planned tasks',
  inputSchema: {
    type: 'object',
    properties: {
      date: { type: 'string' }
    }
  },
  // Returns: { completed: number, total: number, percentage: number }
}
```

**Verify:**
- Tools return correct data
- Task counts match database
- In-progress tasks are accurate

**Done when:** Task query tools work correctly

---

### Task 3: Test conversational recap flow

**Type:** `checkpoint:human-verify` | **Files:** N/A

**Action:**
Manually test the nightly recap flow:

1. Start a conversation: "Let's do tonight's recap"
2. Verify agent:
   - Knows how many tasks you completed
   - Asks about sentiment naturally
   - Inquires about highlights
   - Asks about tomorrow's focus
3. Check that journal entry is created with all fields
4. Verify the diary_entry is in first person
5. Check memory integration for key points

**What to look for:**
- Does it feel conversational or like an interview?
- Does the agent use information it already knows?
- Is the journal entry complete?
- Is the diary entry well-written in first person?

**Done when:** Flow feels natural and creates complete journals

---

## Verification (Overall)

1. **Skill Check:**
   - Skill exists in `global/skills/nightly-recap/SKILL.md`
   - Agent acknowledges the skill

2. **Tool Check:**
   - Task query tools return accurate data
   - Journal creation works

3. **Conversation Check:**
   - Flow is conversational
   - Agent uses known context
   - Journal is complete

## Success Criteria

- [ ] Nightly recap skill exists with complete guidelines
- [ ] Task query tools work correctly
- [ ] Conversational flow feels natural
- [ ] Journal entries are complete and well-formatted
- [ ] Memory integration captures key points

## Output

SUMMARY.md should contain:
- Skill created at `global/skills/nightly-recap/SKILL.md`
- Task query tools added to container
- Test conversation transcript examples
- Sample journal entries created
- Notes on conversation flow improvements
