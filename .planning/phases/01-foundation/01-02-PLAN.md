# PLAN 01-02: Journal System

## Objective

Build the core journal system - creating, storing, and retrieving daily journal entries. Includes integration with the memory system for long-term retention.

## Context

@file:src/db.ts - CRUD functions from 01-01
@file:src/memory-store.ts - Memory system for long-term journal storage
@file:src/ipc-dispatcher.ts - Reference for IPC actions

## Tasks

### Task 1: Create journal manager module

**Type:** `task` | **Files:** `src/journal-manager.ts` (new)

**Action:**
Create a new module that manages journal lifecycle:

```typescript
// Core functions:
export function createJournalEntry(input: JournalInput): DailyJournal;
export function getTodaysJournal(groupFolder: string): DailyJournal | null;
export function updateJournalEntry(id: string, updates: Partial<JournalInput>): void;
export function getJournalContext(groupFolder: string, daysBack?: number): JournalContext;

// Journal context for briefing:
export interface JournalContext {
  today?: DailyJournal;
  yesterday?: DailyJournal;
  weekSummaries: Array<{
    date: string;
    sentiment: string;
    taskCount: number;
    highlights: string[];
  }>;
}
```

**Verify:**
- Create journal entry
- Retrieve today's journal
- Get context with multiple days
- Update existing journal

**Done when:** Module compiles and exports work

---

### Task 2: Add memory integration for journals

**Type:** `task` | **Files:** `src/journal-manager.ts`, container/agent-runner/src/tools.ts

**Action:**
1. When journal is created, automatically store key points in memory:
   - Tasks completed → memory type: `task`
   - Biggest success/error → memory type: `note`
   - Focus for tomorrow → memory type: `task`
2. Add memory recall tool for journals:
   - `search_journals` - search journal content
   - `get_journal_stats` - sentiment trends over time

**Memory items structure:**
```typescript
{
  scope: 'group',
  type: 'task',
  kind: 'episodic',
  content: 'Completed: Fix authentication bug in login flow',
  subject_id: journal.id,
  importance: 0.7,
  tags: ['completed-task', 'dev'],
  metadata: { date: '2026-02-18', category: 'development' }
}
```

**Verify:**
- Create journal → check memory for new entries
- Search journals → should return relevant entries
- Get stats → should show sentiment distribution

**Done when:** Journals automatically integrate with memory system

---

### Task 3: Add IPC action for journal creation

**Type:** `task` | **Files:** `src/ipc-dispatcher.ts`

**Action:**
Add IPC action `create_journal` that agents can call:

```typescript
case 'create_journal': {
  const groupFolder = resolveGroupFolder();
  const journalInput = {
    group_folder: groupFolder,
    date: payload.date, // optional, defaults to today
    tasks_completed: payload.tasks_completed,
    tasks_in_progress: payload.tasks_in_progress,
    sentiment: payload.sentiment,
    biggest_success: payload.biggest_success,
    biggest_error: payload.biggest_error,
    highlights: payload.highlights,
    focus_tomorrow: payload.focus_tomorrow,
    diary_entry: payload.diary_entry,
  };
  const journal = createJournalEntry(journalInput);
  // Trigger memory integration
  await integrateJournalToMemory(journal, groupFolder);
  return { id: requestId, ok: true, result: { journal } };
}
```

**Verify:**
- Agent can call `create_journal` via IPC
- Journal is created in database
- Memory entries are created

**Done when:** IPC action works end-to-end

---

## Verification (Overall)

1. **Module Check:**
   ```bash
   npm run build
   ```
   Should compile with new `journal-manager.ts`

2. **IPC Check:**
   - Create test journal via IPC
   - Verify it appears in database
   - Check memory for integrated entries

3. **Context Check:**
   - Get journal context for multiple days
   - Verify summaries are correct

## Success Criteria

- [ ] Journal manager module exists and exports work
- [ ] Journals automatically integrate with memory system
- [ ] IPC action allows agent to create journals
- [ ] Context retrieval works for briefing generation

## Output

SUMMARY.md should contain:
- Journal manager module created at `src/journal-manager.ts`
- Memory integration pattern for journals
- IPC action added for `create_journal`
- Example journal entries created during testing
