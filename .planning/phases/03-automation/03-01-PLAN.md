# PLAN 03-01: Scheduled Triggers

## Objective

Set up scheduled tasks for automatic daily briefing generation and nightly recap triggers. Uses the existing task scheduler system.

## Context

@file:src/task-scheduler.ts - Existing scheduler
@file:src/db.ts - Task creation functions

## Tasks

### Task 1: Create briefing scheduler module

**Type:** `task` | **Files:** `src/briefing-scheduler.ts` (new)

**Action:**
Create module for scheduling automated briefings:

```typescript
export interface BriefingSchedule {
  group_folder: string;
  timezone: string;
  briefing_time: string;  // HH:MM format
  channel_id: string;     // Where to post briefing
}

export class BriefingScheduler {
  // Schedule daily briefing generation
  scheduleBriefing(config: BriefingSchedule): string;  // Returns task ID

  // Update briefing schedule
  updateSchedule(taskId: string, config: Partial<BriefingSchedule>): void;

  // Remove briefing schedule
  removeSchedule(taskId: string): void;

  // Get active schedule for group
  getSchedule(groupFolder: string): ScheduledTask | null;
}

// Singleton instance
export const briefingScheduler = new BriefingScheduler();
```

**Implementation:**
- Creates a scheduled task with cron expression
- Task calls agent with daily-briefing skill
- Briefing is posted to configured channel
- Task re-schedules itself for next day

**Verify:**
- Can schedule briefing for specific time
- Briefing generates at scheduled time
- Briefing posts to correct channel
- Task recurs daily

**Done when:** Briefings generate automatically

---

### Task 2: Create nightly recap trigger

**Type:** `task** | **Files:** `src/recap-trigger.ts` (new)

**Action:**
Create module for triggering nightly recap:

```typescript
export interface RecapSchedule {
  group_folder: string;
  timezone: string;
  recap_time: string;  // HH:MM format
  channel_id: string;  // Where to start recap
}

export class RecapTrigger {
  // Schedule nightly recap trigger
  scheduleRecap(config: RecapSchedule): string;

  // Update schedule
  updateSchedule(taskId: string, config: Partial<RecapSchedule>): void;

  // Remove schedule
  removeSchedule(taskId: string): void;

  // Get active schedule
  getSchedule(groupFolder: string): ScheduledTask | null;
}

// Singleton instance
export const recapTrigger = new RecapTrigger();
```

**Implementation:**
- Creates scheduled task with cron expression
- Task sends a message to start recap: "Ready for tonight's recap?"
- Agent then uses nightly-recap skill
- Journal is created at end of recap

**Verify:**
- Can schedule recap for specific time
- Recap triggers at scheduled time
- Conversation starts in correct channel
- Journal is created after recap

**Done when:** Recaps trigger automatically

---

### Task 3: Create setup commands for scheduling

**Type:** `task** | **Files:** `src/admin-commands.ts`

**Action:**
Add admin commands for scheduling:

```typescript
// /dotclaw schedule-briefing <HH:MM> [timezone]
// /dotclaw schedule-recap <HH:MM> [timezone]
// /dotclaw show-schedule
// /dotclaw remove-schedule <briefing|recap>
```

**Implementation:**
- Parse time format (HH:MM)
- Validate timezone (default to group's timezone)
- Create scheduled tasks via schedulers
- Show current schedules
- Remove schedules with confirmation

**Verify:**
- Commands are registered
- Can set briefing time
- Can set recap time
- Can view schedules
- Can remove schedules

**Done when:** User can configure schedules via commands

---

## Verification (Overall)

1. **Briefing Schedule:**
   - Set briefing for 9:00 AM
   - Wait/simulate 9:00 AM
   - Briefing appears in channel

2. **Recap Schedule:**
   - Set recap for 10:00 PM
   - Wait/simulate 10:00 PM
   - Recap conversation starts

3. **Commands:**
   - All commands work
   - Schedules persist
   - Can view and remove

## Success Criteria

- [ ] BriefingScheduler module exists
- [ ] RecapTrigger module exists
- [ ] Admin commands for scheduling
- [ ] Briefings generate at scheduled time
- [ ] Recaps trigger at scheduled time
- [ ] Timezone support works

## Output

SUMMARY.md should contain:
- BriefingScheduler at `src/briefing-scheduler.ts`
- RecapTrigger at `src/recap-trigger.ts`
- Admin commands added
- Example schedules created
- Test briefing/recap generated
