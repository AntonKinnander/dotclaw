# PLAN 03-02: State Manager

## Objective

Create a comprehensive state manager that tracks poll completion, task progress, and thread lifecycle. Ensures consistency between Discord API and database.

## Context

@file:src/poll-manager.ts - Poll tracking
@file:src/forum-thread-manager.ts - Thread tracking
@file:src/db.ts - Task storage

## Tasks

### Task 1: Create unified state manager

**Type:** `task** | **Files:** `src/task-state-manager.ts` (new)

**Action:**
Create module for unified task state tracking:

```typescript
export interface TaskState {
  task_id: string;
  status: DailyTask['status'];
  poll_complete: boolean;
  thread_archived: boolean;
  last_sync: string;
  discord_refs: {
    channel_id: string;
    thread_id: string;
    poll_id: string;
  } | null;
}

export class TaskStateManager {
  // Sync all state for a task
  async syncTaskState(taskId: string): Promise<TaskState>;

  // Sync all active tasks
  async syncAllTasks(): Promise<{synced: number; errors: string[]}>;

  // Check if task should be archived
  shouldArchiveTask(taskId: string): boolean;

  // Mark task complete (from poll or reaction)
  async markTaskComplete(taskId: string, source: 'poll' | 'reaction'): Promise<void>;

  // Get tasks needing attention
  async getTasksNeedingAttention(): Promise<{
    overdue: DailyTask[];
    ready_to_archive: DailyTask[];
    stuck: DailyTask[];
  }>;

  // Background sync loop
  startBackgroundSync(intervalMs?: number): void;
  stopBackgroundSync(): void;
}
```

**Implementation:**
- Polls Discord API for current state
- Compares with database state
- Updates on changes
- Archives old tasks automatically
- Runs periodic sync in background

**Verify:**
- State syncs from Discord API
- Background sync runs
- Tasks archive when old
- Attention list is accurate

**Done when:** State manager keeps everything in sync

---

### Task 2: Add Discord API poll fetching

**Type:** `task** | **Files:** `src/providers/discord/discord-provider.ts`

**Action:**
Add methods to fetch current poll state:

```typescript
// Fetch current poll answers and vote counts
async getPollResults(
  channelId: string,
  messageId: string
): Promise<{
  question: string;
  answers: Array<{
    id: number;
    text: string;
    votes: number;
  }>;
  endTime: string | null;
} | null>;

// Check if poll has ended
async isPollEnded(
  channelId: string,
  messageId: string
): Promise<boolean>;

// Get reactions on a message
async getReactions(
  channelId: string,
  messageId: string
): Promise<Array<{emoji: string; count: number}>>;
```

**Verify:**
- Can fetch poll results
- Vote counts are accurate
- Can check poll end time
- Reactions are fetched correctly

**Done when:** Discord API polling methods work

---

### Task 3: Create state persistence layer

**Type:** `task** | **Files:** `src/task-state-manager.ts`

**Action:**
Add persistence for state tracking:

```typescript
interface StateSnapshot {
  last_sync: string;
  tasks: Record<string, {
    status: TaskState;
    hash: string;  // For change detection
  }>;
}

const STATE_FILE = path.join(DATA_DIR, 'task-state-snapshot.json');

export function loadStateSnapshot(): StateSnapshot;
export function saveStateSnapshot(snapshot: StateSnapshot): void;
export function computeTaskHash(task: TaskState): string;
```

**Hash-based Change Detection:**
- Compute hash of task state
- Only update DB if hash changed
- Reduces unnecessary DB writes

**Verify:**
- Snapshot loads and saves
- Hashes are consistent
- Changes are detected correctly
- Unchanged states don't write to DB

**Done when:** State persistence works efficiently

---

## Verification (Overall)

1. **State Sync:**
   - Create task with poll
   - Vote on poll
   - State manager detects change
   - Database updates

2. **Background Sync:**
   - Start background sync
   - Wait for sync interval
   - Check that states updated

3. **Archival:**
   - Create old task (>24h)
   - Run attention check
   - Task is in ready_to_archive list
   - Archive is triggered

## Success Criteria

- [ ] TaskStateManager exists and syncs state
- [ ] Discord API polling methods work
- [ ] Background sync runs periodically
- [ ] Change detection reduces DB writes
- [ ] Tasks are archived automatically

## Output

SUMMARY.md should contain:
- TaskStateManager at `src/task-state-manager.ts`
- Discord API polling methods added
- State persistence implementation
- Background sync configuration
- Test sync results
