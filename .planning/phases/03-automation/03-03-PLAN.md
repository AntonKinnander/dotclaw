# PLAN 03-03: Integration & Polish

## Objective

End-to-end integration of all workflows, error handling, and user controls. Ensure everything works together smoothly.

## Context

All previous phases (01-01 through 03-02)

## Tasks

### Task 1: Create end-to-end workflow tests

**Type:** `task** | **Files:** `test/workflow.test.js` (new)

**Action:**
Create integration tests for complete workflows:

```javascript
// Test 1: Full daily cycle
test('full daily cycle', async () => {
  // 1. Morning briefing generates
  // 2. User plans day with bot
  // 3. Tasks break down and post
  // 4. User completes tasks via polls
  // 5. Evening recap triggers
  // 6. Journal is created
});

// Test 2: Task breakdown and posting
test('task breakdown workflow', async () => {
  // 1. User agrees on task
  // 2. Subagent breaks it down
  // 3. Forum thread created
  // 4. Poll created in thread
  // 5. Poll tracking works
});

// Test 3: Poll completion
test('poll completion detection', async () => {
  // 1. Create task with poll
  // 2. Vote on all options
  // 3. Verify task marked complete
  // 4. Verify thread locked/archived
});

// Test 4: Reaction override
test('reaction override completion', async () => {
  // 1. Create task with poll
  // 2. Add âœ… reaction to thread
  // 3. Verify task marked complete
  // 4. Poll still shows individual progress
});
```

**Verify:**
- All tests pass
- Workflows complete successfully
- State is consistent throughout

**Done when:** Integration tests cover main flows

---

### Task 2: Add error handling and recovery

**Type:** `task** | **Files:** `src/task-workflow-errors.ts` (new)

**Action:**
Create error handling module:

```typescript
export class WorkflowErrorHandler {
  // Handle task creation failures
  async handleTaskCreationError(
    error: Error,
    context: {group_folder: string; task: string}
  ): Promise<void>;

  // Handle poll creation failures
  async handlePollCreationError(
    error: Error,
    taskId: string
  ): Promise<void>;

  // Handle thread creation failures
  async handleThreadCreationError(
    error: Error,
    forumChannelId: string
  ): Promise<void>;

  // Retry failed operations
  async retryFailedOperation(
    operation: () => Promise<void>,
    maxRetries?: number
  ): Promise<boolean>;

  // Log workflow errors for debugging
  logWorkflowError(error: Error, context: Record<string, unknown>): void;
}
```

**Error Scenarios:**
- Discord API rate limits
- Missing permissions
- Invalid channel IDs
- Network timeouts
- Database errors

**Verify:**
- Errors are caught and logged
- User gets helpful error messages
- Failed operations retry appropriately
- State doesn't get corrupted

**Done when:** Errors are handled gracefully

---

### Task 3: Add user controls and configuration

**Type:** `task** | **Files:** `src/admin-commands.ts`

**Action:**
Add commands for user control:

```typescript
// /dotclaw planning-status - Show today's planning status
// /dotclaw reset-planning - Reset today's planning (with confirmation)
// /dotclaw list-tasks [date] - Show tasks for date
// /dotclaw complete-task <id> - Manually mark task complete
// /dotclaw archive-task <id> - Manually archive task
// /dotclaw show-journal [date] - Show journal entry
// /dotclaw configure-workflow - Configure workflow settings:
//   - briefing_time
//   - recap_time
//   - forum_channel_id
//   - auto_archive_hours (default 24)
```

**Configuration Storage:**
```typescript
interface WorkflowConfig {
  group_folder: string;
  briefing_time: string;
  recap_time: string;
  forum_channel_id: string;
  auto_archive_hours: number;
  timezone: string;
}

// Stored in ~/.dotclaw/workflow-config.json
```

**Verify:**
- All commands work
- Configuration persists
- Status displays are accurate
- Manual controls work

**Done when:** User has full control over workflows

---

## Verification (Overall)

1. **End-to-End Test:**
   - Run full daily cycle test
   - All steps complete
   - State is consistent

2. **Error Handling:**
   - Simulate API errors
   - Verify recovery
   - Check error messages

3. **User Controls:**
   - Configure workflow
   - Use manual controls
   - Verify changes take effect

## Success Criteria

- [ ] Integration tests pass
- [ ] Errors are handled gracefully
- [ ] User controls work
- [ ] Configuration persists
- [ ] Full daily cycle works end-to-end

## Output

SUMMARY.md should contain:
- Integration tests created
- Error handling module added
- User control commands added
- Configuration system working
- Full workflow demonstrated
- Any deviations or issues found
